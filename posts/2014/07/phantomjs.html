<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <title>PhantomJSを使ってみた</title>
        <link rel="stylesheet" href="/theme/css/main.css" />

        <!--[if IE]>
            <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="/">blog.gorugle.org </a></h1>
                <nav><ul>
                    <li><a href="/category/embedded.html">Embedded</a></li>
                    <li><a href="/category/misc.html">misc</a></li>
                    <li class="active"><a href="/category/programming.html">Programming</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="/posts/2014/07/phantomjs.html" rel="bookmark"
           title="Permalink to PhantomJSを使ってみた">PhantomJSを使ってみた</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2014-07-20T03:30:00">
                Published: 2014/07/20 Sun
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/lostmangoru.html">lostman/ごる</a>
        </address>
<p>In <a href="/category/programming.html">Programming</a>. </p>
<p>tags: <a href="/tag/javascript.html">JavaScript</a> <a href="/tag/phantomjs.html">PhantomJS</a> </p>
</footer><!-- /.post-info -->      <p>はじめて<a href="http://phantomjs.org/">PhantomJS</a>使ってみました<br />
仕事で間接的に使ったことはありましたが、<br />
プライベートで使ったのははじめてということでテストも兼ねて記事にしてみます</p>
<p>なにに使ったかというと<br />
ドメインの管理ページのDNSの設定の書き換えの自動化です<br />
このサイトのドメインは<a href="http://www.star-domain.jp/">スタードメイン</a>で管理しているのですが、<br />
ここはDDNSの機能は提供していないんですね<br />
このサイトはCNAMEを固定で設定できればいいので特に必要はないんですが、<br />
サブドメインを使って固定IPアドレスでない自宅のマシンにもアクセスできるようにしたかったのです<br />
ただ手動では面倒なのでできれば何らかの方法で自動的に更新しようと考えました</p>
<p>一般的には<a href="http://www.mydns.jp/">MyDNS</a>等の外部のDDNSの機能を提供しているサービスを使用して<br />
このドメインで使用しているネームサーバをDDNSが提供しているものに変更するみたいです<br />
一応この方法も試して動作することも確認しましたが、<br />
PhantomJSを使って書き換える方法も比較的容易に実現できそうだったのでやってみました</p>
<p>ソースは<a href="https://github.com/lostman-github/stardomain-ddns">ここ</a>に置いてあります<br />
READMEにも書いてありますが実行方法は以下です</p>
<div class="highlight"><pre>phantomjs stardomain-ddns.js <span class="s2">&quot;&lt;email address&gt;&quot;</span> <span class="s2">&quot;&lt;password&gt;&quot;</span> <span class="s2">&quot;&lt;file name of DNS records&gt;&quot;</span>
</pre></div>


<p>メールアドレスとパスワードはログインするために必要なもの<br />
あとはDNSの設定が書いてあるファイルのファイル名を指定します<br />
このファイルの中身はスタードメインの管理ページの<br />
「レコード一括編集(テキストエリア)」のページに表示される形式にしておきます<br />
なので一度手動で設定しておいて、一括編集の画面からコピペしてファイルを作ると簡単です<br />
スクリプトを実行すると現在の設定とファイルの中身が一致しなかった場合更新します</p>
<p>このスクリプトを書くにあたってはまった部分がクリックの操作です<br />
inputタグのボタンをクリックするには以下のようします</p>
<div class="highlight"><pre><span class="nx">funcs</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="nx">page</span><span class="p">.</span><span class="nx">evaluate</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">getElementsByName</span><span class="p">(</span><span class="s1">&#39;action_user_dns_index&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="nx">click</span><span class="p">();</span>
  <span class="p">});</span>
<span class="p">});</span>
</pre></div>


<p>しかし、aタグのリンクをクリックしたい場合はうまくいきません (Firefoxでは上の書き方でも動作するんですよね<br />
色々調べたら安心と信頼の<a href="http://stackoverflow.com/questions/2705583/how-to-simulate-a-click-with-javascript/2706236#2706236">Stack Overflow</a>に書いてあったのでそれを参考にしました<br />
以下のようにするとクリックイベントを発生させることができました</p>
<div class="highlight"><pre><span class="nx">funcs</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="nx">page</span><span class="p">.</span><span class="nx">evaluate</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">elem</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementsByClassName</span><span class="p">(</span><span class="s1">&#39;submenu_04&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="nx">firstElementChild</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">e</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createEvent</span><span class="p">(</span><span class="s1">&#39;Events&#39;</span><span class="p">);</span>
    <span class="nx">e</span><span class="p">.</span><span class="nx">initEvent</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
    <span class="nx">elem</span><span class="p">.</span><span class="nx">dispatchEvent</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">});</span>
</pre></div>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>